
<!doctype html>
<html lang=ja>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>108</title>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel=stylesheet>
<style>body,html{margin:0;height:100%;background:#0a0c12;overflow:hidden}canvas{display:block;width:100%;height:100%}body{position:relative;font-family:"Trebuchet MS","Hiragino Sans","Yu Gothic",sans-serif;color:#eee}#start-btn{position:absolute;padding:7px 10px;background:#66d08c;color:#1a1208;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.35);transition:opacity .6s ease,transform .12s ease,box-shadow .12s ease;z-index:5;transform:translate(-50%,-50%);opacity:0;pointer-events:none}#start-btn:hover{transform:translate(-50%,-50%) scale(1.04);box-shadow:0 6px 14px rgba(0,0,0,.45)}#start-btn:active{transform:translate(-50%,-50%) scale(.97);box-shadow:0 2px 6px rgba(0,0,0,.4)}#start-btn.visible{opacity:1;pointer-events:auto}</style>
</head>
<body>
<canvas id=game></canvas>
<button id=start-btn>START</button>
<script>const canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),startBtn=document.getElementById("start-btn"),state={bellHits:0,target:108,swing:{active:!1,start:0,duration:1500,contactHappened:!1},ripples:[],stars:[],shake:0,fadeStart:0,fadeDuration:3e3,fadeDone:!1,audioReady:!1,started:!1,flagIndex:0,particles:[],bellSwing:{angle:0,vel:0},lastTime:null,autoTimer:null,bgmLoopReady:!1,completeTime:null,alpacaBounce:{active:!1,start:0,duration:450,height:26}},bell={x:0,y:0,radius:62},alpaca={x:0,y:0};let FLAG="";const FLAG_COOKIE="flag",AUTO_HIT_INTERVAL=15e3,BGM_TARGET_VOL=.12,BGM_FADE_MS=5e3,BGM_LOOP_HEAD=.5,BGM_LOOP_CUTOFF=.8,bellSound=new Audio("static/bell.mp3");bellSound.preload="auto";const bgm=new Audio("static/bgm.mp3");function loadFlag(){const t=document.cookie.split(";").map((t=>t.trim())).find((t=>t.startsWith("flag=")));if(!t)throw new Error("Flag cookie missing");if(FLAG=decodeURIComponent(t.split("=")[1]||""),108!==FLAG.length)throw new Error(`FLAG length must be 108, got ${FLAG.length}`)}function resize(){canvas.width=innerWidth,canvas.height=innerHeight,bell.x=.55*canvas.width,bell.y=.55*canvas.height;const t=bell.y+bell.radius-6;alpaca.x=bell.x-210,alpaca.y=t+38,ensureStars(),updateStartBtnPos()}function ensureStars(){const t=Math.max(80,Math.floor(canvas.width*canvas.height/15e3));for(;state.stars.length<t;)state.stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height*.6,r:1.6*Math.random()+.4,phase:Math.random()*Math.PI*2})}function playBell(){if(!state.audioReady)return;const t=bellSound.cloneNode();t.volume=.4,t.play().catch((()=>{}))}function triggerSwing(){state.swing.active||state.bellHits>=state.target||(state.swing.active=!0,state.swing.start=performance.now(),state.swing.contactHappened=!1)}function addRipple(){state.ripples.push({t:0}),state.ripples.length>8&&state.ripples.shift()}function update(t){const e=t||performance.now();if(ctx.save(),state.shake>0){const t=(Math.random()-.5)*state.shake,e=(Math.random()-.5)*state.shake;ctx.translate(t,e),state.shake*=.86}drawBackground(e),drawTempleGround(),drawBell(),drawParticles(e),drawAlpaca(e),drawUI(),drawFade(e),ctx.restore();const a=state.lastTime?(e-state.lastTime)/1e3:0;state.lastTime=e,updateSwing(e),updateRipples(),updateBellSway(a),requestAnimationFrame(update)}function drawBackground(t){const e=ctx.createLinearGradient(0,0,0,canvas.height);e.addColorStop(0,"#0c1020"),e.addColorStop(1,"#05060c"),ctx.fillStyle=e,ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#cbd3ff",ctx.globalAlpha=.8;for(const e of state.stars){const a=.4+.6*Math.abs(Math.sin(.0012*t+e.phase));ctx.beginPath(),ctx.arc(e.x,e.y,e.r*a,0,2*Math.PI),ctx.fill()}ctx.globalAlpha=1,ctx.fillStyle="#0a0f17";const a=bell.y+bell.radius-20;ctx.beginPath(),ctx.moveTo(0,a);for(let t=0;t<=canvas.width;t+=40){const e=20+12*Math.sin(.08*t)+4*Math.random();ctx.lineTo(t,a-e)}ctx.lineTo(canvas.width,a+120),ctx.lineTo(0,a+120),ctx.closePath(),ctx.fill()}function drawTempleGround(){const t=bell.y+bell.radius-6,e=ctx.createLinearGradient(0,t,0,t+80);e.addColorStop(0,"#1a1f28"),e.addColorStop(1,"#10141c"),ctx.fillStyle=e,ctx.fillRect(0,t,canvas.width,80);const a=t+14,n=ctx.createLinearGradient(0,a,0,a+52);n.addColorStop(0,"#2b1d14"),n.addColorStop(1,"#1e140e"),ctx.fillStyle=n,ctx.fillRect(0,a,canvas.width,52),ctx.strokeStyle="rgba(255,255,255,0.04)",ctx.lineWidth=2;for(let t=0;t<canvas.width;t+=34)ctx.beginPath(),ctx.moveTo(t,a),ctx.lineTo(t,a+52),ctx.stroke();const l=.5*canvas.width,c=(canvas.width-l)/2,s=t+80-14;for(let t=0;t<4;t++){const e=s+10*t,a=12,n=l+26*t,i=c-13*t;ctx.fillStyle=t%2==0?"#0f141c":"#111722",ctx.fillRect(i,e,n,a),ctx.fillStyle="rgba(255,255,255,0.05)",ctx.fillRect(i,e,n,2)}drawLantern(bell.x-600,t-10),drawLantern(bell.x-300,t-10),drawLantern(bell.x+260,t-10),drawLantern(bell.x+560,t-10)}function drawLantern(t,e){ctx.save(),ctx.translate(t,e),ctx.fillStyle="#141922",ctx.fillRect(-10,18,20,46),ctx.fillStyle="#222a38",ctx.fillRect(-22,8,44,12);const a=ctx.createRadialGradient(0,0,2,0,0,18);a.addColorStop(0,"rgba(255, 210, 130, 0.9)"),a.addColorStop(1,"rgba(255, 210, 130, 0)"),ctx.fillStyle=a,ctx.beginPath(),ctx.arc(0,0,18,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#f5d18a",ctx.fillRect(-8,-6,16,12),ctx.restore()}function drawBell(){ctx.save(),ctx.translate(bell.x,bell.y),ctx.fillStyle="#1d222d",ctx.fillRect(-140,-160,20,300),ctx.fillRect(120,-160,20,300),ctx.fillRect(-140,-160,280,24),ctx.fillStyle="#2a303b",ctx.fillRect(-46,-150,92,16),ctx.fillStyle="#6d5742",ctx.fillRect(-7,-150,14,36),ctx.strokeStyle="#8a7357",ctx.lineWidth=5,ctx.beginPath(),ctx.moveTo(0,-118),ctx.lineTo(0,-32),ctx.stroke(),ctx.save(),ctx.translate(0,-32),ctx.rotate(state.bellSwing.angle),ctx.translate(0,32);ctx.beginPath(),ctx.moveTo(-18,-30),ctx.quadraticCurveTo(-8,-60,0,-62),ctx.quadraticCurveTo(8,-60,18,-30),ctx.quadraticCurveTo(.95*bell.radius,14,.82*bell.radius,64),ctx.quadraticCurveTo(0,1.28*bell.radius,.82*-bell.radius,64),ctx.quadraticCurveTo(.95*-bell.radius,14,-18,-30);const t=ctx.createRadialGradient(0,-12,14,0,10,bell.radius+30);t.addColorStop(0,"#a38435"),t.addColorStop(1,"#5a4015"),ctx.fillStyle=t,ctx.fill();for(const t of state.ripples){const e=Math.min(1,t.t/500);ctx.strokeStyle=`rgba(255, 220, 140, ${1-e})`,ctx.lineWidth=4-3*e,ctx.beginPath(),ctx.arc(0,26,bell.radius+10+28*e,.05*Math.PI,1.95*Math.PI),ctx.stroke()}ctx.restore(),ctx.restore()}bgm.loop=!1,bgm.preload="auto",bgm.volume=0;const spriteScale=6,charSprite=buildSprite();function buildSprite(){const t=["----------------","----------b-b---","---------bbbbb--","---------bfefb--","---------bdedb--","---------bbbbb--","---------bbbbb--","---------bbbbb--","---------bbbbb--","---------bbbbb--","---------bbbbb--","-----bbbbbbbbb--","--ccbbbbbbbbbb--","--bbbbbbbbbbbb--","--bbbbbbbbbbbb--","---cbbbbbbbbbc--","----bcccccbcb---","----b-c---b-b---","----c-c---c-c---","----------------"],e={"-":null,a:"#f6f0e4",b:"#f6f0e4",c:"#e2d8c8",d:"#f5a3a3",e:"#E8E2D8",f:"#2b2b2b"},a=document.createElement("canvas");a.width=t[0].length,a.height=t.length;const n=a.getContext("2d");return t.forEach(((t,a)=>{for(let l=0;l<t.length;l++){const c=e[t[l]];c&&(n.fillStyle=c,n.fillRect(l,a,1,1))}})),a}function drawAlpaca(t){ctx.save();const e=getAlpacaBounceOffset(t);ctx.translate(alpaca.x,alpaca.y-e);ctx.imageSmoothingEnabled=!1,ctx.drawImage(charSprite,-43.2,-94,96,120);const a=swingProgress(t);let n=1;if(state.completeTime){const e=(t-state.completeTime)/1200;n=Math.max(0,1-e)}ctx.globalAlpha=n;const l=20+70*a;ctx.fillStyle="#8b6b44",ctx.beginPath(),ctx.roundRect(l,-40,130,16,8),ctx.fill(),ctx.fillStyle="#cfa86b",ctx.beginPath(),ctx.roundRect(l+130-22,-38,20,12,6),ctx.fill(),ctx.globalAlpha=1,ctx.restore()}function swingProgress(t){if(!state.swing.active)return 0;const e=t-state.swing.start,a=Math.min(1,e/state.swing.duration);return Math.sin(a*Math.PI)}function getAlpacaBounceOffset(t){if(!state.alpacaBounce.active)return 0;const e=t-state.alpacaBounce.start,a=Math.min(1,e/state.alpacaBounce.duration);return a>=1?(state.alpacaBounce.active=!1,0):Math.sin(a*Math.PI)*state.alpacaBounce.height}function triggerAlpacaBounce(){const t=performance.now();state.alpacaBounce.active=!0,state.alpacaBounce.start=t}function updateSwing(t){if(!state.swing.active)return;const e=t-state.swing.start,a=.55*state.swing.duration;!state.swing.contactHappened&&e>=a&&(state.swing.contactHappened=!0,onHit()),e>=state.swing.duration&&(state.swing.active=!1)}function onHit(){state.bellHits=Math.min(state.target,state.bellHits+1),state.shake=8,addRipple(),state.bellSwing.vel-=.3,playBell(),emitFlagChar(),state.bellHits>=state.target&&(stopAuto(),state.completeTime||(state.completeTime=performance.now()))}function updateRipples(){performance.now();state.ripples=state.ripples.filter((t=>(t.t+=16,t.t<900)))}function drawUI(){ctx.save(),ctx.textAlign="center",ctx.textBaseline="top";const t=canvas.width/2;if((state.started||state.bellHits>0)&&(ctx.fillStyle="rgba(255,255,255,0.88)",ctx.font='bold 30px "Trebuchet MS", sans-serif',ctx.fillText(`${state.bellHits} / ${state.target}`,t,30),ctx.font='bold 16px "Trebuchet MS", sans-serif',ctx.fillStyle="rgba(255,255,255,0.7)"),state.flagIndex>0&&(ctx.font='18px "Trebuchet MS", sans-serif',ctx.fillStyle="rgba(255,255,255,0.9)",ctx.fillText(FLAG.slice(0,state.flagIndex),t,72)),state.bellHits>=state.target){ctx.font='28px "Pacifico", sans-serif',ctx.fillStyle="#ffd16d";const t=getAlpacaHeadPos();ctx.fillText("Happy New Year!",t.x,t.y),ctx.textBaseline="bottom",ctx.font='14px "Trebuchet MS", sans-serif',ctx.fillStyle="rgba(255,255,255,0.8)",ctx.fillText("Sound: OtoLogic and VSQ plus+",canvas.width/2,canvas.height-18)}ctx.restore()}function drawFade(t){const e=Math.min(1,(t-state.fadeStart)/state.fadeDuration),a=Math.max(0,1-e);a<=0?state.fadeDone||(state.fadeDone=!0,updateStartBtnPos()):(ctx.fillStyle=`rgba(0, 0, 0, ${a})`,ctx.fillRect(0,0,canvas.width,canvas.height))}function start(){resize(),state.fadeStart=performance.now(),requestAnimationFrame(update)}function unlockAudio(){state.audioReady||(bellSound.play().then((()=>{bellSound.pause(),bellSound.currentTime=0,state.audioReady=!0})).catch((()=>{})),tryStartBgm())}function startAuto(){state.started||(state.started=!0,startBtn.classList.remove("visible"),triggerSwing(),state.autoTimer=setInterval((()=>triggerSwing()),15e3),tryStartBgm())}function stopAuto(){state.autoTimer&&(clearInterval(state.autoTimer),state.autoTimer=null),state.started=!1}function fadeVolume(t,e,a,n){const l=t.volume,c=performance.now(),s=i=>{const o=Math.min(1,(i-c)/a),r=l+(e-l)*o;t.volume=.6*r,o<1?requestAnimationFrame(s):n&&n()};requestAnimationFrame(s),t.paused&&e>0&&t.play().catch((()=>{}))}function tryStartBgm(){state.audioReady&&(bgm.currentTime=0,state.bgmLoopReady||setupSeamlessBgmLoop(),fadeVolume(bgm,.12,5e3))}function setupSeamlessBgmLoop(){state.bgmLoopReady||(state.bgmLoopReady=!0,bgm.addEventListener("timeupdate",(()=>{bgm.duration&&bgm.currentTime>bgm.duration-.8&&(bgm.currentTime=.5,bgm.paused&&bgm.play().catch((()=>{})))})))}function updateStartBtnPos(){if(state.started||!state.fadeDone||state.bellHits>=state.target)return void startBtn.classList.remove("visible");const t=canvas.getBoundingClientRect(),e=alpaca.x+20+65,a=alpaca.y+-40-30;startBtn.style.left=`${t.left+e}px`,startBtn.style.top=`${t.top+a}px`,startBtn.classList.add("visible")}function getAlpacaHeadPos(){return{x:alpaca.x+96*.2,y:alpaca.y-132-getAlpacaBounceOffset(performance.now())}}function getCanvasCoords(t){const e=canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}function isPointInAlpaca(t,e){const a=alpaca.x-43.2,n=alpaca.y-120+26,l=getAlpacaBounceOffset(performance.now());return t>=a&&t<=a+96&&e>=n-l&&e<=n-l+120}function emitFlagChar(){if(state.flagIndex>=FLAG.length)return;const t=FLAG[state.flagIndex++],e=.6*Math.random()-.3-Math.PI/2,a=120+70*Math.random();state.particles.push({ch:t,x:bell.x+10*(Math.random()-.5),y:bell.y,vx:Math.cos(e)*a,vy:Math.sin(e)*a,born:performance.now(),life:5e3})}function updateParticles(t){const e=.016;state.particles=state.particles.filter((a=>!(t-a.born>a.life)&&(a.x+=a.vx*e,a.y+=a.vy*e,a.vy+=8*e,!0)))}function updateBellSway(t){if(!t)return;const e=-7*state.bellSwing.angle;state.bellSwing.vel+=e*t,state.bellSwing.vel*=.99,state.bellSwing.angle+=state.bellSwing.vel*t,state.bellSwing.angle=Math.max(-.5,Math.min(.5,state.bellSwing.angle))}function drawParticles(t){ctx.save(),ctx.textAlign="center",ctx.textBaseline="middle",ctx.font='30px "Trebuchet MS", sans-serif';for(const e of state.particles){const a=t-e.born,n=Math.max(0,1-a/e.life);ctx.fillStyle=`rgba(255, 221, 140, ${n})`,ctx.fillText(e.ch,e.x,e.y)}ctx.restore(),updateParticles(t)}async function boot(){try{loadFlag(),start()}catch(t){alert("Flag load failed: "+t.message)}}window.addEventListener("resize",resize),window.addEventListener("pointerdown",unlockAudio,{once:!0}),window.addEventListener("keydown",unlockAudio,{once:!0}),startBtn.addEventListener("click",(()=>{unlockAudio(),startAuto()})),canvas.addEventListener("pointerdown",(t=>{const{x:e,y:a}=getCanvasCoords(t);isPointInAlpaca(e,a)&&triggerAlpacaBounce()})),CanvasRenderingContext2D.prototype.roundRect||(CanvasRenderingContext2D.prototype.roundRect=function(t,e,a,n,l){const c=Math.min(l,a/2,n/2);this.beginPath(),this.moveTo(t+c,e),this.lineTo(t+a-c,e),this.quadraticCurveTo(t+a,e,t+a,e+c),this.lineTo(t+a,e+n-c),this.quadraticCurveTo(t+a,e+n,t+a-c,e+n),this.lineTo(t+c,e+n),this.quadraticCurveTo(t,e+n,t,e+n-c),this.lineTo(t,e+c),this.quadraticCurveTo(t,e,t+c,e),this.closePath()}),boot()</script>
</body>
</html>